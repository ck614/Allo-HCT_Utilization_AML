---
title: "Disparities in Allogeneic Hematopoietic Stem Cell Transplantation Among Acute Myeloid Leukemia Patients"
output: html_document
date: "2025-05-10"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Install packages
```{r}
pacman::p_load(readr, dplyr, tidyverse, table1, patchwork, 
               broom, nnet, lme4, broom.mixed, gtsummary, 
               writexl, lmerTest, readxl, openxlsx, forcats, 
               ggplot2, forestplot)
```

# Import data
```{r}
AML_raw <- read_fwf('/Users/ckck/Library/CloudStorage/Box-Box/NCDB AML 02192024/NCDB_PUF_DATA_Feb-20-2024/NCDBPUF_AMyLeuk.0.2021.0.dat',
                    na = ".",
                    fwf_positions(c(1, 38, 48, 49, 50,
                                    53, 54, 56, 57, 59,
                                    60, 61, 62, 63, 64,
                                    65, 75, 77, 79, 88, 
                                    93, 246, 300, 338, 354,
                                    362, 371, 388, 389, 967,
                                    968, 316, 351, 73), 
                                  c(37, 47, 48, 49, 52,
                                    53, 55, 56, 58, 59,
                                    60, 61, 62, 63, 64, 
                                    72, 76, 78, 82, 91, 
                                    93, 253, 307, 339, 361, 
                                    362, 372, 388, 389, 967,
                                    968, 317, 351, 74)))

colnames(AML_raw)<- c("PUF_CASE_ID", "PUF_FACILITY_ID", "FACILITY_TYPE_CD", "FACILITY_LOCATION_CD","AGE", 
                      "SEX", "RACE", "SPANISH_HISPANIC_ORIGIN", "INSURANCE_STATUS", "MED_INC_QUAR_00", 
                      "NO_HSD_QUAR_00", "UR_CD_03", "MED_INC_QUAR_12", "NO_HSD_QUAR_12", "UR_CD_13", 
                      "CROWFLY", "SEQUENCE_NUMBER", "CLASS_OF_CASE", "YEAR_OF_DIAGNOSIS", "HISTOLOGY", 
                      "PUF_MULT_SOURCE", "DX_RX_STARTED_DAYS", "DX_SYSTEMIC_STARTED_DAYS", "RX_SUMM_TRNSPLNT_ENDO", "DX_LASTCONTACT_DEATH_MONTHS", 
                      "PUF_VITAL_STATUS", "RX_HOSP_OTHER", "NO_HSD_QUAR_2016", "MED_INC_QUAR_2016", "NO_HSD_QUAR_2020", 
                      "MED_INC_QUAR_2020", "RX_SUMM_CHEMO", "RX_SUMM_TREATMENT_STATUS", "CDCC_TOTAL_BEST")

# Sample size = 177,927
```

# Data Cleaning
```{r}
AML <- AML_raw
```

## Data cleaning: outcome variable "transplant_cat"
```{r}
AML$RX_SUMM_TRNSPLNT_ENDO<- as.numeric(AML$RX_SUMM_TRNSPLNT_ENDO)

AML <- AML %>% 
  mutate(transplant = case_when(RX_SUMM_TRNSPLNT_ENDO == 0 ~ 0, 
                                RX_SUMM_TRNSPLNT_ENDO == 10 ~ 1,
                                RX_SUMM_TRNSPLNT_ENDO == 11 ~ 2,
                                RX_SUMM_TRNSPLNT_ENDO == 12 ~ 3,
                                RX_SUMM_TRNSPLNT_ENDO == 20 ~ 4,
                                RX_SUMM_TRNSPLNT_ENDO == 30 ~ 5,
                                RX_SUMM_TRNSPLNT_ENDO == 40 ~ 6,
                                RX_SUMM_TRNSPLNT_ENDO == 82 ~ 7,
                                RX_SUMM_TRNSPLNT_ENDO == 85 ~ 8,
                                RX_SUMM_TRNSPLNT_ENDO == 86 ~ 9,
                                RX_SUMM_TRNSPLNT_ENDO == 87 ~ 10,
                                RX_SUMM_TRNSPLNT_ENDO == 88 ~ 11,
                                RX_SUMM_TRNSPLNT_ENDO == 99 ~ 12)) %>%
  mutate(transplant_cat = case_when(RX_SUMM_TRNSPLNT_ENDO %in% c(0, 87) ~ 0,  # No transplant
                                    RX_SUMM_TRNSPLNT_ENDO %in% c(12, 20) ~ 1,  # Allogeneic transplant
                                    TRUE ~ 2)) # Other/unclear treatments

# Change into factor and add labels
AML$transplant <- factor(AML$transplant, levels = c(0:12), 
                         labels = c(
                           "0: No transplant procedure or endocrine therapy was administered as part of first course therapy", 
                           "10: A bone marrow transplant procedure was administered, but the type was not specified", 
                           "11: Bone marrow transplant - autologous", 
                           "12: Bone marrow transplant - allogeneic", 
                           "20: Stem cell harvest and infusion. Umbilical cord stem cell transplant, with blood from one or multiple umbilical cords.", 
                           "30: Endocrine surgery and/or endocrine radiation therapy",
                           "40: Combination of endocrine surgery and/or radiation with a transplant procedure. (Combination of codes 30 and 10, 11, 12, or 20)",
                           "82: Hematologic transplant and/or endocrine surgery/radiation was not recommended/administered because it was contraindicated due to patient risk factors (i.e, comorbid conditions, advanced age, progression of disease prior to administration, etc.)",
                           "85: Hematologic transplant and/or endocrine surgery/radiation was not administered because the patient died prior to planned or recommended therapy.",
                           "86: Hematologic transplant and/or endocrine surgery/radiation was not administered. It was recommended by the patient's physician, but was not administered as part of the first course of therapy. No reason was stated in patient record",
                           "87: Hematologic transplant and/or endocrine surgery/radiation was not administered. It was recommended by the patient's physician, but this treatment was refused by the patient, a patient's family member, or the patient's guardian. The refusal was noted in patient record ",
                           "88: Hematologic transplant and/or endocrine surgery/radiation was recommended, but it is unknown if it was administered",
                           "99: It is unknown whether hematologic transplant and/or endocrine surgery/radiation was recommended or administered because it is not stated in patient record."))

# Retrieve sample size for each category for Figure 1
table(AML$transplant, useNA = "always")

# Remove "Other/unclear treatments" category
AML <- subset(AML, transplant_cat == 0 | transplant_cat == 1)

# Change transplant_cat to factor
AML$transplant_cat <- factor(AML$transplant_cat, 
                             levels = c(0:1), 
                             labels = c("0: No transplant", "1: allogeneic transplant"))

AML <- AML %>% relocate(c(RX_SUMM_TRNSPLNT_ENDO, transplant, transplant_cat), .after = PUF_CASE_ID) 

table(AML$transplant_cat, useNA = "always")

# Sample size = 173,244 (no transplant N = 155,176, Allo-HCT N = 18,068)
# 177927 - 173244 = 4,683
```

## Restrict sample to patients from facilities (PUF_FACILITY_ID) that has continuous AML case report from 2004 to 2021 (study period)
```{r}
full_year <- 2004:2021

# Summarize AML report years for each PUF_FACILITY_ID 
facility_years <- AML %>%
  group_by(PUF_FACILITY_ID) %>%
  summarize(years = list(unique(YEAR_OF_DIAGNOSIS)))

# Keep facilities that have continuous report from 2004 to 2021
valid_facility_ID <- facility_years %>%
  rowwise() %>%
  filter(all(full_year %in% years)) %>%
  pull(PUF_FACILITY_ID)

# Subset full dataset with facilities that have continuous AML report from 2004 to 2021
AML <- AML %>% 
  filter(PUF_FACILITY_ID %in% valid_facility_ID)

# Sample size after exclusion = 135,835
# 173244 - 135835 = 37,409
table(AML$transplant_cat, useNA = "always")
```

### Double check for filtering facilities with continuous AML report from 2004 to 2021
```{r}
AML_check <- subset(AML, select = c("PUF_FACILITY_ID", "YEAR_OF_DIAGNOSIS"))

# Create a dataset with PUF_FACILITY_ID as rows and YEAR_OF_DIAGNOSIS as columns
# if this facility has at least one AML reported in that year, then value = 1, if there is no AML case report, then value = 0 
AML_check_wide <- AML_check %>%
  distinct(PUF_FACILITY_ID, YEAR_OF_DIAGNOSIS) %>%
  mutate(value = 1) %>%
  pivot_wider(
    names_from = YEAR_OF_DIAGNOSIS,
    values_from = value,
    values_fill = 0) %>%
  relocate(PUF_FACILITY_ID, sort(as.character(2004:2021)))

# Sum up all values
AML_check_wide$count <- rowSums(AML_check_wide[ , as.character(2004:2021)])

# Retrieve PUF_FACILITY_ID with count = 18 (representing continuous AML case report from 2004 to 2021)
valid_facility_ID_check <- AML_check_wide %>%
  filter(count == 18) %>%
  pull(PUF_FACILITY_ID)

# Check if the two filtered facility lists are equivalent
setequal(valid_facility_ID_check, valid_facility_ID) # True
```

## Data cleaning: HISTOLOGY
```{r}
AML$HISTOLOGY <- as.character(AML$HISTOLOGY)

AML$HISTOLOGY <- factor(AML$HISTOLOGY,
                        levels = c(9840, 9861, 9866, 9867, 9871, 
                                   9872, 9873, 9874, 9895, 9896,
                                   9897, 9898, 9910, 9911, 9920), 
                        labels = c("9840: Acute erythroid leukemia", 
                                   "9861: Acute myeloid leukemia",
                                   "9866: Acute promyelocytic leukemia with a variant RARA translocation", 
                                   "9867: Acute myelomonocytic leukaemia, NOS",
                                   "9871: Acute myeloid leukaemia with CBFB::MYH11 fusion",
                                   "9872: Acute myeloid leukaemia, minimal differentiation",
                                   "9873: Acute myeloid leukaemia without maturation",
                                   "9874: Acute myeloid leukaemia with maturation",
                                   "9895: Acute myeloid leukaemia with myelodysplasia-related changes",
                                   "9896: Acute myeloid leukaemia with RUNX1::RUNX1T1 fusion",
                                   "9897: Acute myeloid Leukaemia with KMT2A rearrangement",
                                   "9898: Myeloid leukaemia associated with Down syndrome",
                                   "9910: Acute megakaryoblastic leukaemia",
                                   "9911: Acute myeloid Leukaemia with RBM15::MRTFA fusion",
                                   "9920: Therapy-related acute myeloid leukaemia, NOS"))

# Exclude 9866: Acute promyelocytic leukemia due to: https://pmc.ncbi.nlm.nih.gov/articles/PMC8012800/
AML <- AML %>%
  filter(HISTOLOGY != "9866: Acute promyelocytic leukemia with a variant RARA translocation") %>% # excluded N = 12,148
  mutate(HISTOLOGY = fct_drop(HISTOLOGY))

# Sample size = 123,687
```

## Data cleaning: FACILITY_TYPE_CD (excluded patients diagosed between 18 to 39 years)
```{r}
AML <- AML %>%
  filter(!is.na(FACILITY_TYPE_CD)) # Patients diagnosed < 40 yo were excluded because they do not have facility type information

# table(AML$AGE, useNA = "always")
# Age 18-39:
# 314 + 386 + 373 + 384 + 422 + 391 + 448 + 380 + 478 + 469 + 500 + 519 + 486 + 519 + 541 + 596 + 571 + 595 + 620 + 630 + 614 + 656 = 10,892

AML$FACILITY_TYPE_CD <- as.character(AML$FACILITY_TYPE_CD)

# Create a factor for facility_type
AML$facility_type <- NA
AML$facility_type <- factor(AML$FACILITY_TYPE_CD, 
                            levels = c(1:4), 
                            labels = c("Community Cancer Program", 
                                       "Comprehensive Community Cancer Program",
                                       "Academic/Research Program (includes NCI-designated comprehensive cancer centers)", 
                                       "Integrated Network Cancer Program"))

# Relevel Academic/Research Program as the reference level
AML$facility_type <- relevel(AML$facility_type, 
                             ref = "Academic/Research Program (includes NCI-designated comprehensive cancer centers)")

# Combine "Community Cancer Program" and "Comprehensive Community Cancer Program"
AML$facility_type_cat <- NA
AML$facility_type_cat[AML$facility_type %in% c("Academic/Research Program (includes NCI-designated comprehensive cancer centers)")] <- 0
AML$facility_type_cat[AML$facility_type %in% c("Community Cancer Program", "Comprehensive Community Cancer Program")] <- 1
AML$facility_type_cat[AML$facility_type %in% c("Integrated Network Cancer Program")] <- 2

# Factorize facility_type_cat
AML$facility_type_cat <- factor(AML$facility_type_cat, 
                                levels = c(0:2), 
                                labels = c("Academic/Research Program", "Community Cancer Program", "Integrated Network Cancer Program"))

AML <- AML %>% relocate(c(facility_type, facility_type_cat), .after = FACILITY_TYPE_CD)

# Sample size = 112,795
```

## Data cleaning: sex
```{r}
AML$sex <- NA
AML$sex[AML$SEX == 1] <- 0 # male coded as 0
AML$sex[AML$SEX == 2] <- 1 # female coded as 1

AML <- AML %>% relocate(sex, .after = SEX) 

# Change sex to factor
AML$sex<- factor(AML$sex,levels = c(0:1), labels = c("Male","Female"))

# Sample size = 112,795
```

## Data cleaning: race/ethnicity
```{r}
AML$RACE<- as.numeric(AML$RACE)

# Non-Hispanic White
AML$race_eth_cat <- NA
AML$race_eth_cat[AML$RACE == 1 & AML$SPANISH_HISPANIC_ORIGIN == 0] <- 0 

# Non-Hispanic Black 
AML$race_eth_cat[AML$RACE == 2 & AML$SPANISH_HISPANIC_ORIGIN == 0] <- 1 

# Non-Hispanic Asian/Pacific Islander (4: Chinese, 5: Japanese, 6: Filipino, 7: Hawaiian, 8: Korean, 10: Vietnamese, 11: Laotian, 12: Hmong, 13: Kampuchean, 14: Thai, 15: Asian Indian or Pakistani, 20: Micronesian, 21: Chamorran, 22: Guamanian, 25: Polynesian, 26: Tahitian, 27: Samoan, 28: Tongan, 30: Melanesian, 31: Fiji Islander, 32: New Guinean, 96: Other Asian, 97: Pacific Islander)
AML$race_eth_cat[AML$RACE >= 4 & AML$RACE <= 97 & AML$SPANISH_HISPANIC_ORIGIN == 0] <- 2

# Hispanics
AML$race_eth_cat[AML$SPANISH_HISPANIC_ORIGIN >= 1 & AML$SPANISH_HISPANIC_ORIGIN <= 8] <- 3

# Other (including Non-Hispanic American Indian/Alaska Native (3: American Indian, Aleutian, or Eskimo)/Unknown
AML$race_eth_cat[
  (AML$RACE == 3 & AML$SPANISH_HISPANIC_ORIGIN == 0) | 
  (AML$RACE %in% c(98, 99) | AML$SPANISH_HISPANIC_ORIGIN == 9)] <- 4

AML <- AML %>% relocate(race_eth_cat, .after = SPANISH_HISPANIC_ORIGIN) 

# Change race_eth_cat to factor
AML$race_eth_cat <- factor(AML$race_eth_cat,levels = c(0:4),labels = c("NHW","NHB","NHAPI", "HIS", "Other/Unknown")) 

# Sample size = 112,795
```

## Data cleaning: insurance
```{r}
AML$INSURANCE_STATUS <- as.character(AML$INSURANCE_STATUS)

# Collapse insurance_cat
AML <- AML %>%
  mutate(insurance_cat = case_when(INSURANCE_STATUS == 1 ~ 0, # Private
                                   INSURANCE_STATUS == 2 ~ 1, # Medicaid
                                   INSURANCE_STATUS == 3 ~ 2, # Medicare
                                   INSURANCE_STATUS == 4 | INSURANCE_STATUS == 0 | INSURANCE_STATUS == 9 ~ 3,)) %>% # Not/Other/Unknown
  relocate(insurance_cat, .after = INSURANCE_STATUS) 

# Change insurance_cat to factor
AML$insurance_cat<-factor(AML$insurance_cat, 
                          levels = c(0:3),
                          labels = c("Private", "Medicaid", "Medicare", "Not/Other/Unknown"))
# Sample size = 112,795
```

## Data cleaning: Great circle distance
```{r}
# Great circle distance: the "great circle" distance in miles between the patient's residence and the hospital that reported the case
AML <- AML %>% rename(gcdistance_num = CROWFLY) %>% 
  drop_na(gcdistance_num) # After exclusion, N = 99,897

# Because gcdistance_num has extremely large values, so we transformed gcdistance_num into a categorical variable
quantile(AML$gcdistance_num, probs = seq(0, 1, 0.02), na.rm = TRUE) 

# Create a percentile plot to see the distribution of gcdistance_num
AML$gcdistance_num_rank <- rank(AML$gcdistance_num) / length(AML$gcdistance_num) * 100
ggplot(AML, aes(x = gcdistance_num_rank, y = gcdistance_num)) +
  geom_point(color = "blue") +          
  geom_line(color = "red") +
  scale_x_continuous(breaks = seq(0, max(AML$gcdistance_num_rank), by = 5)) +
  scale_y_continuous(breaks = seq(0, max(AML$gcdistance_num) + 20, by = 500)) + 
  labs(x = "Great circle distance percentile", y = "Actual great circle distance") +
  ggtitle("Great circle distance by Percentile") +
  theme(plot.title = element_text(hjust = 0.5))

# Cut gcdistance_num into 4 categories
AML$gcdistance_num_quartile <- cut(AML$gcdistance_num, 
                                   breaks = c(-Inf, 10, 50, 100, Inf),  
                                   include.lowest = FALSE, 
                                   right = FALSE,  # ensures left-inclusive, right-exclusive intervals
                                   labels = c("<10", "10 to <50", "50 to <100", "≥100"))

AML <- AML %>% relocate(c(gcdistance_num_rank, gcdistance_num_quartile), .after = gcdistance_num) 

# Linearity check for gcdistance_num
gcdistance_num_linearity <- glm(transplant_cat ~ gcdistance_num, 
                                data = AML, family = binomial)
fitted_values_gcdistance_num <- fitted(gcdistance_num_linearity)
residuals_gcdistance_num <- residuals(gcdistance_num_linearity, type = "response")  

# Create a residuals vs. fitted values plot
ggplot(AML, aes(x = fitted_values_gcdistance_num, y = residuals_gcdistance_num)) +
  geom_point() +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray") +
  labs(x = "Fitted Values", y = "Residuals", title = "Residuals vs. Fitted Values")

# Conclude a non-linear pattern

# Sample size = 99,897
# 112795 - 99897 = 12898
```

## Data cleaning: area of residence (Rural/urban)
```{r}
# Recode area of residence (value: 1 to 9) as "rucc" (value 0 to 8) using census data based on year of diagnosis
AML <- AML %>%
  mutate(rucc = case_when(
    YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008 ~ 
      if_else(UR_CD_03 %in% 1:9, UR_CD_03 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS >= 2009 & YEAR_OF_DIAGNOSIS <= 2021 ~ 
      if_else(UR_CD_13 %in% 1:9, UR_CD_13 - 1, NA_real_),
    TRUE ~ NA_real_)) # if YEAR_OF_DIAGNOSIS is not in 2004-2021, assign NA

# Change rucc to factor
AML$rucc <- factor(AML$rucc, 
                   levels = c(0:8), 
                   labels = c("Counties in metro areas of ≥ 1 million", 
                              "Counties in metro areas of 250,000 to 1 million", 
                              "Counties in metro areas of <250,000", 
                              "Urban population of ≥20,000, adjacent to a metro area", 
                              "Urban population of ≥20,000, not adjacent to a metro area", 
                              "Urban population of 2,500 to 19,999, adjacent to a metro area", 
                              "Urban population of 2,500 to 19,999, not adjacent to a metro area", 
                              "Completely rural or ≤2,500 urban population, adjacent to a metro area", 
                              "Completely rural or ≤2,500 urban population, not adjacent to a metro area")) 

# Collapse rucc into 2 categories
AML <- AML %>%
  mutate(rucc_cat = case_when(rucc %in% c("Counties in metro areas of ≥ 1 million", 
                                          "Counties in metro areas of 250,000 to 1 million", 
                                          "Counties in metro areas of <250,000") ~ 0,
                              rucc %in% c("Urban population of ≥20,000, adjacent to a metro area", 
                                          "Urban population of ≥20,000, not adjacent to a metro area", 
                                          "Urban population of 2,500 to 19,999, adjacent to a metro area", 
                                          "Urban population of 2,500 to 19,999, not adjacent to a metro area", 
                                          "Completely rural or ≤2,500 urban population, adjacent to a metro area", 
                                          "Completely rural or ≤2,500 urban population, not adjacent to a metro area") ~ 1)) %>%
  relocate(c(UR_CD_13, rucc, rucc_cat), .after = UR_CD_03) 

AML$rucc_cat <- factor(AML$rucc_cat, 
                       levels = c(0:1), 
                       labels = c("Metro", "Nonmetro"))

# remove NA values
AML <- AML[!is.na(AML$rucc_cat), ]
# Sample size = 94,994
# 99897 - 94994 = 4903
```

## Data cleaning: zip-code-level education 
```{r}
# Recode education quartiles (value: 1 to 4) as "education_cat" (value 0 to 3) using census data based on year of diagnosis
AML <- AML %>%
  mutate(education_cat = case_when(
    YEAR_OF_DIAGNOSIS == 2004 ~  
      if_else(NO_HSD_QUAR_00 %in% 1:4, NO_HSD_QUAR_00 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS > 2004 & YEAR_OF_DIAGNOSIS <= 2012 ~ 
      if_else(NO_HSD_QUAR_12 %in% 1:4, NO_HSD_QUAR_12 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS >= 2013 & YEAR_OF_DIAGNOSIS <= 2016 ~ 
      if_else(NO_HSD_QUAR_2016 %in% 1:4, NO_HSD_QUAR_2016 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021 ~ 
      if_else(NO_HSD_QUAR_2020 %in% 1:4, NO_HSD_QUAR_2020 - 1, NA_real_),
    TRUE ~ NA_real_)) # if YEAR_OF_DIAGNOSIS is not in 2004-2021, assign NA

# Change education_cat to factor
AML$education_cat <- factor(AML$education_cat, 
                            levels = c(0:3), 
                            labels = c("Lowest Category", "Second Category", "Third Category", "Highest Category"))

AML <- AML %>% relocate(c(NO_HSD_QUAR_12, NO_HSD_QUAR_2016, NO_HSD_QUAR_2020, education_cat), .after = NO_HSD_QUAR_00) 
# Sample size = 94,994
```

## Data cleaning: zip-code-level median household income
```{r}
# Recode income quartiles (value: 1 to 4) as "income_cat" (value 0 to 3) using census data based on year of diagnosis
AML <- AML %>%
  mutate(income_cat = case_when(
    YEAR_OF_DIAGNOSIS == 2004 ~ 
      if_else(MED_INC_QUAR_00 %in% 1:4, MED_INC_QUAR_00 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS > 2004 & YEAR_OF_DIAGNOSIS <= 2012 ~ 
      if_else(MED_INC_QUAR_12 %in% 1:4, MED_INC_QUAR_12 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS >= 2013 & YEAR_OF_DIAGNOSIS <= 2016 ~ 
      if_else(MED_INC_QUAR_2016 %in% 1:4, MED_INC_QUAR_2016 - 1, NA_real_),
    YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021 ~ 
      if_else(MED_INC_QUAR_2020 %in% 1:4, MED_INC_QUAR_2020 - 1, NA_real_),
    TRUE ~ NA_real_)) # if YEAR_OF_DIAGNOSIS is not in 2004-2021, assign NA

# Change income_cat to factor
AML$income_cat <- factor(AML$income_cat, 
                         levels = c(0:3), 
                         labels = c("Lowest Category", "Second Category", "Third Category", "Highest Category"))

AML <- AML %>% relocate(c(MED_INC_QUAR_12, MED_INC_QUAR_2016, MED_INC_QUAR_2020, income_cat), .after = MED_INC_QUAR_00) 

# remove income_cat with NA values
# table(AML$income_cat, useNA = "always")
AML <- AML[!is.na(AML$income_cat), ] 

# Sample size = 94,246
# 94994 - 94246 = 748
```

## Data cleaning: age at diagnosis
```{r}
AML$AGE <- as.numeric(AML$AGE)

range(AML$AGE) # 40, 90
# This is because only patients who are 40 yo and above at diagnosis have facility type information, as shown in a preceding chunk. 

# Collapse age into 4 categories
AML <- AML %>%
  mutate(age_cat = case_when(AGE >= 40 & AGE < 50 ~ 0,
                             AGE >= 50 & AGE < 60 ~ 1, 
                             AGE >= 60 & AGE < 70 ~ 2,
                             AGE >= 70 ~ 3)) %>% 
  relocate(age_cat, .after = AGE) 

# Change age_cat to factor
AML$age_cat <- factor(AML$age_cat, 
                      levels = c(0:3), 
                      labels = c("age_4049", "age_5059", "age_6069", "age_70+"))
# Sample size = 94,246
```

## Data cleaning: Charlson-Deyo score
```{r}
AML$charlson_cat <- as.character(AML$CDCC_TOTAL_BEST)

# Change charlson_cat to factor
AML$charlson_cat <- factor(AML$charlson_cat, 
                           levels = c(0:3), 
                           labels = c("0: Total Charlson-Deyo Score of 0", 
                                      "1: Total Charlson-Deyo Score of 1",
                                      "2: Total Charlson-Deyo Score of 2", 
                                      "3: Total Charlson-Deyo Score of 3 or more"))

AML <- AML %>% relocate(charlson_cat, .after = CDCC_TOTAL_BEST) 
# Sample size = 94,246
```

# Subset dataset to relevant variables only
```{r}
AML <- AML %>%
  select(sex, race_eth_cat, insurance_cat,
         facility_type_cat, gcdistance_num_quartile, 
         rucc_cat, education_cat, income_cat,
         YEAR_OF_DIAGNOSIS, age_cat, charlson_cat,
         transplant_cat, PUF_FACILITY_ID) %>%
  drop_na() # make sure no NA in the final dataset

str(AML)
# Final sample size = 94,246
```

# Baseline table 1
```{r}
# Baseline characteristics for table 1 (grouped by transplant_cat)
baseline_bytransplant <- AML %>%
  tbl_summary(include = c(sex, race_eth_cat, insurance_cat,
                          facility_type_cat, gcdistance_num_quartile,
                          rucc_cat, education_cat, income_cat,
                          age_cat, charlson_cat, YEAR_OF_DIAGNOSIS),
    by = transplant_cat,
    statistic = list(all_continuous() ~ "{median} ({p25}, {p75})",
                     all_categorical() ~ "{n} ({p}%)"),
    percent = "column",
    digits = list(all_categorical() ~ c(0, 1))) %>%
  add_p(pvalue_fun = function(x) style_pvalue(x, digits = 2))

# Convert to dataframe
baseline_bytransplant <- as.data.frame(baseline_bytransplant)

# Baseline characteristics for table 1 (not grouped by transplant_cat)
baseline_nosep <- AML %>% 
  tbl_summary(include = c(sex, race_eth_cat, insurance_cat,
                          facility_type_cat, gcdistance_num_quartile,
                          rucc_cat, education_cat, income_cat,
                          age_cat, charlson_cat, YEAR_OF_DIAGNOSIS),  
    statistic = list(all_continuous() ~ "{median} ({p25}, {p75})",
                     all_categorical() ~ "{n} ({p}%)"),
    percent = "column",
    digits = list(all_categorical() ~ c(0, 1)))

baseline_nosep <- as.data.frame(baseline_nosep)

# Combine two dataframes for table 1 export
baseline <- cbind(baseline_nosep, baseline_bytransplant)

# Remove duplicate columns
baseline = baseline[, -3] 
```

## Create a workbook to store all results
```{r}
result_excel <- createWorkbook()

addWorksheet(result_excel, "Baseline")
writeData(result_excel, "Baseline", baseline)
```

# Odds ratio
```{r}
# str(AML$transplant_cat)

# Rescale YEAR_OF_DIAGNOSIS to make 2004 = 0, 2005 = 1
AML <- AML %>%
  mutate(YEAR_OF_DIAGNOSIS_scaled = YEAR_OF_DIAGNOSIS - 2004)

# Model
glmodel <- glmer(transplant_cat ~ sex + race_eth_cat + insurance_cat +
                   facility_type_cat + gcdistance_num_quartile +
                   rucc_cat + education_cat + income_cat +
                   age_cat + charlson_cat + YEAR_OF_DIAGNOSIS_scaled + 
                   (1|PUF_FACILITY_ID), 
                 data = AML, 
                 family = binomial(link = "logit"),
                 control = glmerControl(optimizer = "bobyqa", optCtrl = list(maxfun = 200000)))

# The default optimizer is optimizer = "nloptwrap", but it is hard to converge for mixed effect and complex models. So we used optimizer = "bobyqa", which is commonly used for complex models

# Exponentiate for odds ratios
glmodel_result <- tidy(glmodel, exponentiate = TRUE, conf.int = TRUE) 
glmodel_result <- glmodel_result %>%
  mutate(
    p.value = sprintf("%.3f", p.value),
    across(where(is.numeric) & !matches("p.value"), ~ sprintf("%.2f", .)))
```

## Save OR results to the excel file
```{r}
addWorksheet(result_excel, "OR")
writeData(result_excel, "OR", glmodel_result) 
```

# Linear Models
## Adjust variable type for implementing the following linear models
```{r}
AML$transplant_cat <- as.numeric(AML$transplant_cat) -1 # ensure no transplant = 0, transplant = 1
AML$YEAR_OF_DIAGNOSIS <- as.numeric(AML$YEAR_OF_DIAGNOSIS)
```

## Race/ethnicity
### Percent of Allo-HCT by rac/ethnicity and year of diagnosis
```{r}
# str(AML$transplant_cat)
AML_freqtable_raceeth <- subset(AML, select = c("YEAR_OF_DIAGNOSIS", "transplant_cat", "race_eth_cat"))

# Calculate transplant rate (%) by year of diagnosis and race/ethnicity
transplant_rate_raceeth_long <- AML_freqtable_raceeth %>%
  group_by(YEAR_OF_DIAGNOSIS, race_eth_cat) %>%
  summarize(
    rate_yearraceeth = sum(((transplant_cat == 1) / n())*100))

transplant_rate_raceeth <- transplant_rate_raceeth_long %>%
  pivot_wider(
    names_from = race_eth_cat,               
    values_from = rate_yearraceeth 
  ) %>%   
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))%>%
  mutate(YEAR_OF_DIAGNOSIS = as.character(YEAR_OF_DIAGNOSIS))

# Calculate average transplant rate from 2004 to 2021
average_rate_raceeth <- AML_freqtable_raceeth %>%
  group_by(race_eth_cat) %>%
  summarize(
    mean_rate_raceeth = sum(((transplant_cat == 1) / n())*100)) %>%
  pivot_wider(
    names_from = race_eth_cat,               
    values_from = mean_rate_raceeth 
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate("YEAR_OF_DIAGNOSIS" = "Average transplant rate from 2004 to 2021") %>%
  select(YEAR_OF_DIAGNOSIS, everything())

# Calculate the increase: (average of 2017-2021) - (average of 2004-2008)
early_period_raceeth <- AML_freqtable_raceeth %>%
  filter(YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008) %>%
  group_by(race_eth_cat) %>%
  summarize(
    early_mean_raceeth = sum(((transplant_cat == 1) / n())*100))

late_period_raceeth <- AML_freqtable_raceeth %>%
  filter(YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021) %>%
  group_by(race_eth_cat) %>%
  summarize(
    late_mean_raceeth = sum(((transplant_cat == 1) / n())*100))

increase_raceeth <- left_join(early_period_raceeth, late_period_raceeth, by = "race_eth_cat") %>%
  mutate(Increase = late_mean_raceeth - early_mean_raceeth) %>%
  select(race_eth_cat, early_mean_raceeth, late_mean_raceeth, Increase) %>% 
  pivot_longer(
    cols = c(early_mean_raceeth, late_mean_raceeth, Increase),
    names_to = "YEAR_OF_DIAGNOSIS",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = race_eth_cat,
    values_from = Value
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate(YEAR_OF_DIAGNOSIS = dplyr::recode(YEAR_OF_DIAGNOSIS,
                                    "early_mean_raceeth" = "Early period average rate",
                                    "late_mean_raceeth" = "Late period average rate",
                                    "Increase" = "Increase from 2004-2008 to 2017-2021")) %>%
  select(YEAR_OF_DIAGNOSIS, everything())

rate_raceeth = rbind(transplant_rate_raceeth, average_rate_raceeth)
rate_raceeth = rbind(rate_raceeth, increase_raceeth)
```

### Save rate result into excel file
```{r}
addWorksheet(result_excel, "Raceeth rate")
writeData(result_excel, "Raceeth rate", rate_raceeth)
```

### Plot of Percent of Allo-HCT by race/ethnicity group and year of diagnosis
```{r}
custom_colors <- c("NHW" = "#E41A1C",        
                   "NHB" = "#984ea3",  
                   "NHAPI" = "#FF7F00",
                   "HIS" = "#377EB8",
                   "Other/Unknown" = "#4daf4a")

custom_labels <- c("NHW" = "Non-Hispanic White",
                   "NHB" = "Non-Hispanic Black",
                   "NHAPI" = "Non-Hispanic Asian/Pacific Islander",
                   "HIS" = "Hispanic",
                   "Other/Unknown" = "Other/Unknown")

tiff("LM Transplant rate race_eth.tiff", units = "in", width = 7, height = 5, res = 300)
ggplot(transplant_rate_raceeth_long, aes(x = YEAR_OF_DIAGNOSIS, y = rate_yearraceeth, color = race_eth_cat, group = race_eth_cat)) +
  geom_smooth(se = TRUE, method = "lm", alpha = 0.25) +
  scale_color_manual(values = custom_colors, 
                     labels = custom_labels) +
  geom_point() +
  labs(
    title = "Allo-HCT Rate by Race/ethnicity",
    x = "Year of Diagnosis",
    y = "Allo-HCT Rate (%)",
    color = "Race/ethnicity"
  ) +
  scale_y_continuous(
    limits = c(0, 25),
    breaks = seq(0, 25, by = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 14),
        legend.position = c(0.22, 0.775),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "gray", linewidth = 0.3)) +
  scale_x_continuous(breaks = unique(transplant_rate_raceeth_long$YEAR_OF_DIAGNOSIS))
dev.off()
```

### Linear model for year of diagnosis * race/ethnicity
```{r}
lm_model_raceeth <- lmer(transplant_cat ~ sex + insurance_cat +
                           facility_type_cat + gcdistance_num_quartile +
                           rucc_cat + education_cat + income_cat + 
                           age_cat + charlson_cat + 
                           YEAR_OF_DIAGNOSIS * race_eth_cat + 
                           (1 | PUF_FACILITY_ID),
                         data = AML)

lm_model_raceeth <- tidy(lm_model_raceeth, exponentiate = FALSE, conf.int = TRUE) %>% 
  mutate(
    conf.low = as.numeric(conf.low), 
    conf.high = as.numeric(conf.high),
    estimate = sprintf("%.4f", estimate),
    std.error = sprintf("%.4f", std.error),
    statistic = sprintf("%.4f", statistic),
    p.value = sprintf("%.3f", p.value),
    conf.low = sprintf("%.4f", conf.low),
    conf.high = sprintf("%.4f", conf.high)
  )
```

### Save lm result into excel file
```{r}
addWorksheet(result_excel, "Raceeth lm")
writeData(result_excel, "Raceeth lm", lm_model_raceeth)
```


## Insurance
### Percent of Allo-HCT by insurance and year of diagnosis
```{r}
AML_freqtable_insurance <- subset(AML, select = c("YEAR_OF_DIAGNOSIS", "transplant_cat", "insurance_cat"))

# Calculate transplant rate (%) by year of diagnosis and insurance
transplant_rate_insurance_long <- AML_freqtable_insurance %>%
  group_by(YEAR_OF_DIAGNOSIS, insurance_cat) %>%
  summarize(
    rate_yearinsurance = sum(((transplant_cat == 1) / n())*100))

transplant_rate_insurance <- transplant_rate_insurance_long %>%
  pivot_wider(
    names_from = insurance_cat,               
    values_from = rate_yearinsurance 
  ) %>%   
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))%>%
  mutate(YEAR_OF_DIAGNOSIS = as.character(YEAR_OF_DIAGNOSIS))

# Calculate average transplant rate from 2004 to 2021
average_rate_insurance <- AML_freqtable_insurance %>%
  group_by(insurance_cat) %>%
  summarize(
    mean_rate_insurance = sum(((transplant_cat == 1) / n())*100)) %>%
  pivot_wider(
    names_from = insurance_cat,               
    values_from = mean_rate_insurance 
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate("YEAR_OF_DIAGNOSIS" = "Average transplant rate from 2004 to 2021") %>%
  select(YEAR_OF_DIAGNOSIS, everything())

# Calculate the increase: (average of 2017-2021) - (average of 2004-2008)
early_period_insurance <- AML_freqtable_insurance %>%
  filter(YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008) %>%
  group_by(insurance_cat) %>%
  summarize(
    early_mean_insurance = sum(((transplant_cat == 1) / n())*100))

late_period_insurance <- AML_freqtable_insurance %>%
  filter(YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021) %>%
  group_by(insurance_cat) %>%
  summarize(
    late_mean_insurance = sum(((transplant_cat == 1) / n())*100))

increase_insurance <- left_join(early_period_insurance, late_period_insurance, by = "insurance_cat") %>%
  mutate(Increase = late_mean_insurance - early_mean_insurance) %>%
  select(insurance_cat, early_mean_insurance, late_mean_insurance, Increase) %>% 
  pivot_longer(
    cols = c(early_mean_insurance, late_mean_insurance, Increase),
    names_to = "YEAR_OF_DIAGNOSIS",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = insurance_cat,               
    values_from = Value 
  )%>%
  mutate(YEAR_OF_DIAGNOSIS = dplyr::recode(YEAR_OF_DIAGNOSIS,
                                    "early_mean_insurance" = "Early period average rate",
                                    "late_mean_insurance" = "Late period average rate",
                                    "Increase" = "Increase from 2004-2008 to 2017-2021")) %>%
  select(YEAR_OF_DIAGNOSIS, everything()) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))

rate_insurance = rbind(transplant_rate_insurance, average_rate_insurance)
rate_insurance = rbind(rate_insurance, increase_insurance)
```

### Save rate result into excel file
```{r}
addWorksheet(result_excel, "Insurance rate")
writeData(result_excel, "Insurance rate", rate_insurance)
```

### Plot of Percent of Allo-HCT by insurance and year of diagnosis
```{r}
custom_colors <- c("Private" = "#e41a1c",        
                   "Medicaid" = "#984ea3",  
                   "Medicare" = "#ff7f00",
                   "Not/Other/Unknown" = "#377eb8")

custom_labels <- c("Private" = "Private",        
                   "Medicaid" = "Medicaid",  
                   "Medicare" = "Medicare",
                   "Not/Other/Unknown" = "Not/Other/Unknown")

tiff("LM Transplant rate insurance.tiff", units = "in", width = 7, height = 5, res = 300)
ggplot(transplant_rate_insurance_long, aes(x = YEAR_OF_DIAGNOSIS, y = rate_yearinsurance, color = insurance_cat, group = insurance_cat)) +
  geom_smooth(se = TRUE, method = "lm", alpha = 0.25) +
  scale_color_manual(values = custom_colors, labels = custom_labels) +
  geom_point() +
  labs(
    title = "Allo-HCT Rate by Insurance",
    x = "Year of Diagnosis",
    y = "Allo-HCT Rate (%)",
    color = "Insurance"
  ) +
  scale_y_continuous(
    limits = c(0, 35),
    breaks = seq(0, 35, by = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 14),
        legend.position = c(0.15, 0.805),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "gray", linewidth = 0.3)) +
  scale_x_continuous(breaks = unique(transplant_rate_insurance_long$YEAR_OF_DIAGNOSIS))
dev.off()
```

### Linear model for year of diagnosis * insurance
```{r}
lm_model_insurance <- lmer(transplant_cat ~ sex + race_eth_cat + 
                             facility_type_cat + gcdistance_num_quartile +
                             rucc_cat + education_cat + income_cat + 
                             age_cat + charlson_cat + 
                             YEAR_OF_DIAGNOSIS * insurance_cat + 
                             (1 | PUF_FACILITY_ID),
                           data = AML)

lm_model_insurance <- tidy(lm_model_insurance, exponentiate = FALSE, conf.int = TRUE) %>% 
  mutate(
    conf.low = as.numeric(conf.low), 
    conf.high = as.numeric(conf.high),
    estimate = sprintf("%.4f", estimate),
    std.error = sprintf("%.4f", std.error),
    statistic = sprintf("%.4f", statistic),
    p.value = sprintf("%.3f", p.value),
    conf.low = sprintf("%.4f", conf.low),
    conf.high = sprintf("%.4f", conf.high)
  )
```

### Save lm result into excel file
```{r}
addWorksheet(result_excel, "Insurance type lm")
writeData(result_excel, "Insurance type lm", lm_model_insurance)
```

## Facility type
### Percent of Allo-HCT by facility type and year of diagnosis
```{r}
AML_freqtable_facitype <- subset(AML, select = c("YEAR_OF_DIAGNOSIS", "transplant_cat", "facility_type_cat"))

# Calculate transplant rate (%) by year of diagnosis and facility type
transplant_rate_facitype_long <- AML_freqtable_facitype %>%
  group_by(YEAR_OF_DIAGNOSIS, facility_type_cat) %>%
  summarize(
    rate_yearfacitype = sum(((transplant_cat == 1) / n())*100))

transplant_rate_facitype <- transplant_rate_facitype_long %>%
  pivot_wider(
    names_from = facility_type_cat,               
    values_from = rate_yearfacitype 
  ) %>%   
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))%>%
  mutate(YEAR_OF_DIAGNOSIS = as.character(YEAR_OF_DIAGNOSIS))

# Calculate average transplant rate from 2004 to 2021
average_rate_facitype <- AML_freqtable_facitype %>%
  group_by(facility_type_cat) %>%
  summarize(
    mean_rate_facitype = sum(((transplant_cat == 1) / n())*100)) %>%
  pivot_wider(
    names_from = facility_type_cat,               
    values_from = mean_rate_facitype 
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate("YEAR_OF_DIAGNOSIS" = "Average transplant rate from 2004 to 2021") %>%
  select(YEAR_OF_DIAGNOSIS, everything())

# Calculate the increase: (average of 2017-2021) - (average of 2004-2008)
early_period_facitype <- AML_freqtable_facitype %>%
  filter(YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008) %>%
  group_by(facility_type_cat) %>%
  summarize(
    early_mean_facitype = sum(((transplant_cat == 1) / n())*100))

late_period_facitype <- AML_freqtable_facitype %>%
  filter(YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021) %>%
  group_by(facility_type_cat) %>%
  summarize(
    late_mean_facitype = sum(((transplant_cat == 1) / n())*100))

increase_facitype <- left_join(early_period_facitype, late_period_facitype, by = "facility_type_cat") %>%
  mutate(Increase = late_mean_facitype - early_mean_facitype) %>%
  select(facility_type_cat, early_mean_facitype, late_mean_facitype, Increase) %>% 
  pivot_longer(
    cols = c(early_mean_facitype, late_mean_facitype, Increase),
    names_to = "YEAR_OF_DIAGNOSIS",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = facility_type_cat,               
    values_from = Value 
  ) %>%
  mutate(YEAR_OF_DIAGNOSIS = recode(YEAR_OF_DIAGNOSIS,
                                    "early_mean_facitype" = "Early period average rate",
                                    "late_mean_facitype" = "Late period average rate",
                                    "Increase" = "Increase from 2004-2008 to 2017-2021")) %>% 
  select(YEAR_OF_DIAGNOSIS, everything()) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))

rate_facitype = rbind(transplant_rate_facitype, average_rate_facitype)
rate_facitype = rbind(rate_facitype, increase_facitype)
```

### Save rate result into excel file
```{r}
addWorksheet(result_excel, "Facility type rate")
writeData(result_excel, "Facility type rate", rate_facitype)
```

### Plot of Percent of Allo-HCT by facility type and year of diagnosis
```{r}
custom_colors <- c("Academic/Research Program" = "#ED0000",        
                   "Community Cancer Program" = "#984ea3",  
                   "Integrated Network Cancer Program" = "#ff7f00")

custom_labels <- c("Academic/Research Program" = "Academic/research program",        
                   "Community Cancer Program" = "Community cancer program",  
                   "Integrated Network Cancer Program" = "Integrated network cancer program")


tiff("LM Transplant rate facitype.tiff", units = "in", width = 7, height = 5, res = 300)
ggplot(transplant_rate_facitype_long, aes(x = YEAR_OF_DIAGNOSIS, y = rate_yearfacitype, color = facility_type_cat, group = facility_type_cat)) +
  geom_smooth(se = TRUE, method = "lm", alpha = 0.25) +
  scale_color_manual(values = custom_colors, labels = custom_labels) +
  geom_point() +
  labs(
    title = "Allo-HCT Rate by Facility Type",
    x = "Year of Diagnosis",
    y = "Allo-HCT Rate (%)",
    color = "Facility Type"
  ) +
  scale_y_continuous(
    limits = c(0, 25),
    breaks = seq(0, 25, by = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 14),
        legend.position = c(0.22, 0.825),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "gray", linewidth = 0.3)) +
  scale_x_continuous(breaks = unique(transplant_rate_facitype_long$YEAR_OF_DIAGNOSIS))
dev.off()
```

### Linear model for year of diagnosis * facility type
```{r}
lm_model_facitype <- lmer(transplant_cat ~ sex + race_eth_cat + insurance_cat +
                            gcdistance_num_quartile +
                            rucc_cat + education_cat + income_cat + 
                            age_cat + charlson_cat + 
                            YEAR_OF_DIAGNOSIS * facility_type_cat + 
                            (1 | PUF_FACILITY_ID),
                          data = AML)

lm_model_facitype <- tidy(lm_model_facitype, exponentiate = FALSE, conf.int = TRUE) %>% 
  mutate(
    conf.low = as.numeric(conf.low), 
    conf.high = as.numeric(conf.high),
    estimate = sprintf("%.4f", estimate),
    std.error = sprintf("%.4f", std.error),
    statistic = sprintf("%.4f", statistic),
    p.value = sprintf("%.3f", p.value),
    conf.low = sprintf("%.4f", conf.low),
    conf.high = sprintf("%.4f", conf.high)
  )
```

### Save lm result into excel file
```{r}
addWorksheet(result_excel, "Facility type lm")
writeData(result_excel, "Facility type lm", lm_model_facitype)
```

## Great circle distance
### Percent of Allo-HCT by GCD and year of diagnosis
```{r}
AML_freqtable_gcd <- subset(AML, select = c("YEAR_OF_DIAGNOSIS", "transplant_cat", "gcdistance_num_quartile"))

# Calculate transplant rate (%) by year of diagnosis and great circle distance
transplant_rate_gcd_long <- AML_freqtable_gcd %>%
  group_by(YEAR_OF_DIAGNOSIS, gcdistance_num_quartile) %>%
  summarize(
    rate_yeargcd = sum(((transplant_cat == 1) / n())*100))

transplant_rate_gcd <- transplant_rate_gcd_long %>%
  pivot_wider(
    names_from = gcdistance_num_quartile,               
    values_from = rate_yeargcd 
  ) %>%   
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))%>%
  mutate(YEAR_OF_DIAGNOSIS = as.character(YEAR_OF_DIAGNOSIS))

# Calculate average transplant rate from 2004 to 2021
average_rate_gcd <- AML_freqtable_gcd %>%
  group_by(gcdistance_num_quartile) %>%
  summarize(
    mean_rate_gcd = sum(((transplant_cat == 1) / n())*100)) %>%
  pivot_wider(
    names_from = gcdistance_num_quartile,               
    values_from = mean_rate_gcd 
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate("YEAR_OF_DIAGNOSIS" = "Average transplant rate from 2004 to 2021") %>%
  select(YEAR_OF_DIAGNOSIS, everything())

# Calculate the increase: (average of 2017-2021) - (average of 2004-2008)
early_period_gcd <- AML_freqtable_gcd %>%
  filter(YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008) %>%
  group_by(gcdistance_num_quartile) %>%
  summarize(
    early_mean_gcd = sum(((transplant_cat == 1) / n())*100))

late_period_gcd <- AML_freqtable_gcd %>%
  filter(YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021) %>%
  group_by(gcdistance_num_quartile) %>%
  summarize(
    late_mean_gcd = sum(((transplant_cat == 1) / n())*100))

increase_gcd <- left_join(early_period_gcd, late_period_gcd, by = "gcdistance_num_quartile") %>%
  mutate(Increase = late_mean_gcd - early_mean_gcd) %>%
  select(gcdistance_num_quartile, early_mean_gcd, late_mean_gcd, Increase) %>% 
  pivot_longer(
    cols = c(early_mean_gcd, late_mean_gcd, Increase),
    names_to = "YEAR_OF_DIAGNOSIS",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = gcdistance_num_quartile,
    values_from = Value
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate(YEAR_OF_DIAGNOSIS = dplyr::recode(YEAR_OF_DIAGNOSIS,
                                    "early_mean_gcd" = "Early period average rate",
                                    "late_mean_gcd" = "Late period average rate",
                                    "Increase" = "Increase from 2004-2008 to 2017-2021")) %>%
  select(YEAR_OF_DIAGNOSIS, everything())

rate_gcd = rbind(transplant_rate_gcd, average_rate_gcd)
rate_gcd = rbind(rate_gcd, increase_gcd)
```

### Save rate result into excel file
```{r}
addWorksheet(result_excel, "Gcd rate")
writeData(result_excel, "Gcd rate", rate_gcd)
```

### Plot of Percent of Allo-HCT by GCD and year of diagnosis
```{r}
custom_colors <- c("<10" = "#e41a1c",        
                   "10 to <50" = "#984ea3",  
                   "50 to <100" = "#ff7f00",
                   "≥100" = "#377eb8")

custom_labels <- c("<10" = "<10",
                   "10 to <50" = "10 to <50",
                   "50 to <100" = "50 to <100",
                   "≥100" = "≥100")

tiff("LM Transplant rate gcd.tiff", units = "in", width = 7, height = 5, res = 300)
ggplot(transplant_rate_gcd_long, aes(x = YEAR_OF_DIAGNOSIS, y = rate_yeargcd, color = gcdistance_num_quartile, group = gcdistance_num_quartile)) +
  geom_smooth(se = TRUE, method = "lm", alpha = 0.25) +
  scale_color_manual(values = custom_colors, 
                     labels = custom_labels) +
  geom_point() +
  labs(
    title = "Allo-HCT Rate by Great Circle Distance",
    x = "Year of Diagnosis",
    y = "Allo-HCT Rate (%)",
    color = "Great Circle Distance (miles)"
  ) +
  scale_y_continuous(
    limits = c(0, 30),
    breaks = seq(0, 30, by = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 14),
        legend.position = c(0.20, 0.80),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "gray", linewidth = 0.3)) +
  scale_x_continuous(breaks = unique(transplant_rate_gcd_long$YEAR_OF_DIAGNOSIS))
dev.off()
```

### Linear model for year of diagnosis * GCD
```{r}
lm_model_gcd <- lmer(transplant_cat ~ sex + race_eth_cat + insurance_cat +
                       facility_type_cat +
                       rucc_cat + education_cat + income_cat + 
                       age_cat + charlson_cat + 
                       YEAR_OF_DIAGNOSIS * gcdistance_num_quartile + 
                       (1 | PUF_FACILITY_ID),
                     data = AML)

lm_model_gcd <- tidy(lm_model_gcd, exponentiate = FALSE, conf.int = TRUE) %>% 
  mutate(
    conf.low = as.numeric(conf.low), 
    conf.high = as.numeric(conf.high),
    estimate = sprintf("%.4f", estimate),
    std.error = sprintf("%.4f", std.error),
    statistic = sprintf("%.4f", statistic),
    p.value = sprintf("%.3f", p.value),
    conf.low = sprintf("%.4f", conf.low),
    conf.high = sprintf("%.4f", conf.high)
  )
```

### Save lm result into excel file
```{r}
addWorksheet(result_excel, "Gcd lm")
writeData(result_excel, "Gcd lm", lm_model_gcd)
```


## Education level
### Percent of Allo-HCT by education level and year of diagnosis
```{r}
AML_freqtable_education <- subset(AML, select = c("YEAR_OF_DIAGNOSIS", "transplant_cat", "education_cat"))

# Calculate transplant rate (%) by year of diagnosis and education type
transplant_rate_education_long <- AML_freqtable_education %>%
  group_by(YEAR_OF_DIAGNOSIS, education_cat) %>%
  summarize(
    rate_yeareducation = sum(((transplant_cat == 1) / n())*100))

transplant_rate_education <- transplant_rate_education_long %>%
  pivot_wider(
    names_from = education_cat,               
    values_from = rate_yeareducation 
  ) %>%   
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))%>%
  mutate(YEAR_OF_DIAGNOSIS = as.character(YEAR_OF_DIAGNOSIS))

# Calculate average transplant rate from 2004 to 2021
average_rate_education <- AML_freqtable_education %>%
  group_by(education_cat) %>%
  summarize(
    mean_rate_education = sum(((transplant_cat == 1) / n())*100)) %>%
  pivot_wider(
    names_from = education_cat,               
    values_from = mean_rate_education 
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate("YEAR_OF_DIAGNOSIS" = "Average transplant rate from 2004 to 2021") %>%
  select(YEAR_OF_DIAGNOSIS, everything())

# Calculate the increase: (average of 2017-2021) - (average of 2004-2008)
early_period_education <- AML_freqtable_education %>%
  filter(YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008) %>%
  group_by(education_cat) %>%
  summarize(
    early_mean_education = sum(((transplant_cat == 1) / n())*100))

late_period_education <- AML_freqtable_education %>%
  filter(YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021) %>%
  group_by(education_cat) %>%
  summarize(
    late_mean_education = sum(((transplant_cat == 1) / n())*100))

increase_education <- left_join(early_period_education, late_period_education, by = "education_cat") %>%
  mutate(Increase = late_mean_education - early_mean_education) %>%
  select(education_cat, early_mean_education, late_mean_education, Increase) %>% 
  pivot_longer(
    cols = c(early_mean_education, late_mean_education, Increase),
    names_to = "YEAR_OF_DIAGNOSIS",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = education_cat,               
    values_from = Value 
  )%>%
  mutate(YEAR_OF_DIAGNOSIS = dplyr::recode(YEAR_OF_DIAGNOSIS,
                                    "early_mean_education" = "Early period average rate",
                                    "late_mean_education" = "Late period average rate",
                                    "Increase" = "Increase from 2004-2008 to 2017-2021")) %>%
  select(YEAR_OF_DIAGNOSIS, everything()) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))

rate_education = rbind(transplant_rate_education, average_rate_education)
rate_education = rbind(rate_education, increase_education)
```

### Save rate result into excel file
```{r}
addWorksheet(result_excel, "Education rate")
writeData(result_excel, "Education rate", rate_education)
```

### Plot of Percent of Allo-HCT by Zip-code-level education and year of diagnosis
```{r}
custom_colors <- c("Lowest Category" = "#e41a1c",        
                   "Second Category" = "#984ea3",  
                   "Third Category" = "#ff7f00",
                   "Highest Category" = "#377eb8")

custom_labels <- c("Lowest Category" = "1st quartile (lowest)",        
                   "Second Category" = "2nd quartile",  
                   "Third Category" = "3rd quartile",
                   "Highest Category" = "4th quartile (highest)")

tiff("LM Transplant rate education.tiff", units = "in", width = 7, height = 5, res = 300)
ggplot(transplant_rate_education_long, aes(x = YEAR_OF_DIAGNOSIS, y = rate_yeareducation, color = education_cat, group = education_cat)) +
  geom_smooth(se = TRUE, method = "lm", alpha = 0.25) +
  scale_color_manual(values = custom_colors,
                     labels = custom_labels) +
  geom_point() +
  labs(
    title = "Allo-HCT Rate by Zip-code-level Education",
    x = "Year of Diagnosis",
    y = "Allo-HCT Rate (%)",
    color = "Zip-code-level Education"
  ) +
 scale_y_continuous(
    limits = c(0, 25),
    breaks = seq(0, 25, by = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 14),
        legend.position = c(0.17, 0.795),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "gray", linewidth = 0.3)) +
  scale_x_continuous(breaks = unique(transplant_rate_education_long$YEAR_OF_DIAGNOSIS))
dev.off()
```

### Linear model for year of diagnosis * education level
```{r}
lm_model_education <- lmer(transplant_cat ~ sex + race_eth_cat + insurance_cat +
                             facility_type_cat + gcdistance_num_quartile +
                             rucc_cat + income_cat +
                             age_cat + charlson_cat + 
                             YEAR_OF_DIAGNOSIS * education_cat + 
                             (1 | PUF_FACILITY_ID),
                           data = AML)

lm_model_education <- tidy(lm_model_education, exponentiate = FALSE, conf.int = TRUE) %>% 
  mutate(
    conf.low = as.numeric(conf.low), 
    conf.high = as.numeric(conf.high),
    estimate = sprintf("%.4f", estimate),
    std.error = sprintf("%.4f", std.error),
    statistic = sprintf("%.4f", statistic),
    p.value = sprintf("%.3f", p.value),
    conf.low = sprintf("%.4f", conf.low),
    conf.high = sprintf("%.4f", conf.high)
  )
```

### Save lm result into excel file
```{r}
addWorksheet(result_excel, "Education lm")
writeData(result_excel, "Education lm", lm_model_education)
```

## Income level
### Percent of Allo-HCT by income level and year of diagnosis
```{r}
AML_freqtable_income <- subset(AML, select = c("YEAR_OF_DIAGNOSIS", "transplant_cat", "income_cat"))

# Calculate transplant rate (%) by year of diagnosis and income level
transplant_rate_income_long <- AML_freqtable_income %>%
  group_by(YEAR_OF_DIAGNOSIS, income_cat) %>%
  summarize(
    rate_yearincome = sum(((transplant_cat == 1) / n())*100))

transplant_rate_income <- transplant_rate_income_long %>%
  pivot_wider(
    names_from = income_cat,               
    values_from = rate_yearincome 
  ) %>%   
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))%>%
  mutate(YEAR_OF_DIAGNOSIS = as.character(YEAR_OF_DIAGNOSIS))

# Calculate average transplant rate from 2004 to 2021
average_rate_income <- AML_freqtable_income %>%
  group_by(income_cat) %>%
  summarize(
    mean_rate_income = sum(((transplant_cat == 1) / n())*100)) %>%
  pivot_wider(
    names_from = income_cat,               
    values_from = mean_rate_income 
  ) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .))) %>%
  mutate("YEAR_OF_DIAGNOSIS" = "Average transplant rate from 2004 to 2021") %>%
  select(YEAR_OF_DIAGNOSIS, everything())

# Calculate the increase: (average of 2017-2021) - (average of 2004-2008)
early_period_income <- AML_freqtable_income %>%
  filter(YEAR_OF_DIAGNOSIS >= 2004 & YEAR_OF_DIAGNOSIS <= 2008) %>%
  group_by(income_cat) %>%
  summarize(
    early_mean_income = sum(((transplant_cat == 1) / n())*100))

late_period_income <- AML_freqtable_income %>%
  filter(YEAR_OF_DIAGNOSIS >= 2017 & YEAR_OF_DIAGNOSIS <= 2021) %>%
  group_by(income_cat) %>%
  summarize(
    late_mean_income = sum(((transplant_cat == 1) / n())*100))

increase_income <- left_join(early_period_income, late_period_income, by = "income_cat") %>%
  mutate(Increase = late_mean_income - early_mean_income) %>%
  select(income_cat, early_mean_income, late_mean_income, Increase) %>% 
  pivot_longer(
    cols = c(early_mean_income, late_mean_income, Increase),
    names_to = "YEAR_OF_DIAGNOSIS",
    values_to = "Value"
  ) %>%
  pivot_wider(
    names_from = income_cat,               
    values_from = Value 
  )%>%
  mutate(YEAR_OF_DIAGNOSIS = dplyr::recode(YEAR_OF_DIAGNOSIS,
                                    "early_mean_income" = "Early period average rate",
                                    "late_mean_income" = "Late period average rate",
                                    "Increase" = "Increase from 2004-2008 to 2017-2021")) %>%
  select(YEAR_OF_DIAGNOSIS, everything()) %>%
  mutate(across(where(is.numeric), ~ sprintf("%.2f%%", .)))

rate_income = rbind(transplant_rate_income, average_rate_income)
rate_income = rbind(rate_income, increase_income)
```

### Save rate result into excel file
```{r}
addWorksheet(result_excel, "Income rate")
writeData(result_excel, "Income rate", rate_income)
```

### Plot of Percent of Allo-HCT by zip-code-level Income and year of diagnosis
```{r}
custom_colors <- c("Lowest Category" = "#e41a1c",        
                   "Second Category" = "#984ea3",  
                   "Third Category" = "#ff7f00",
                   "Highest Category" = "#377eb8")

custom_labels <- c("Lowest Category" = "1st quartile (lowest)",        
                   "Second Category" = "2nd quartile",  
                   "Third Category" = "3rd quartile",
                   "Highest Category" = "4th quartile (highest)")

tiff("LM Transplant rate income.tiff", units = "in", width = 7, height = 5, res = 300)
ggplot(transplant_rate_income_long, aes(x = YEAR_OF_DIAGNOSIS, y = rate_yearincome, color = income_cat, group = income_cat)) +
  geom_smooth(se = TRUE, method = "lm", alpha = 0.25) +
  scale_color_manual(values = custom_colors, labels = custom_labels) +
  geom_point() +
  labs(
    title = "Allo-HCT Rate by Zip-code-level Income",
    x = "Year of Diagnosis",
    y = "Allo-HCT Rate (%)",
    color = "Zip-code-level Income"
  ) +
  scale_y_continuous(
    limits = c(0, 20),
    breaks = seq(0, 20, by = 5)) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 0.5),
        plot.title = element_text(hjust = 0.5, size = 14),
        legend.position = c(0.16, 0.80),
        panel.grid.minor = element_blank(),
        panel.grid.major = element_blank(),
        panel.grid.major.y = element_line(color = "gray", linewidth = 0.3)) +
  scale_x_continuous(breaks = unique(transplant_rate_income_long$YEAR_OF_DIAGNOSIS))
dev.off()
```

### Linear model for year of diagnosis * income Level
```{r}
lm_model_income <- lmer(transplant_cat ~ sex + race_eth_cat + insurance_cat +
                          facility_type_cat + gcdistance_num_quartile +
                          rucc_cat + education_cat +
                          age_cat + charlson_cat + 
                          YEAR_OF_DIAGNOSIS * income_cat + 
                          (1 | PUF_FACILITY_ID),
                        data = AML)

lm_model_income <- tidy(lm_model_income, exponentiate = FALSE, conf.int = TRUE) %>% 
  mutate(
    conf.low = as.numeric(conf.low), 
    conf.high = as.numeric(conf.high),
    estimate = sprintf("%.4f", estimate),
    std.error = sprintf("%.4f", std.error),
    statistic = sprintf("%.4f", statistic),
    p.value = sprintf("%.3f", p.value),
    conf.low = sprintf("%.4f", conf.low),
    conf.high = sprintf("%.4f", conf.high)
  )
```

### Save lm result into excel file
```{r}
addWorksheet(result_excel, "Income lm")
writeData(result_excel, "Income lm", lm_model_income)
```

# Export all results
```{r}
saveWorkbook(result_excel, "/Users/ckck/Desktop/WashU Research/Allo-HCT disparities/Linear model/Code versions/result_excel.xlsx", 
             overwrite = FALSE)
```


# Create forest plot for annual absolute changes visualization
```{r}
# The last sheet in the Excel file was manually created from the exported results in the previous sheets and was used to generate the forest plot.

forest <- read_excel("/Users/ckck/Desktop/WashU Research/Allo-HCT disparities/Linear model/Code versions/result_excel.xlsx",
                     sheet = "Forest plot")
```

## forest plot
```{r}
forest[c("coef", "cilower", "ciupper", "p")] <- lapply(forest[c("coef", "cilower", "ciupper", "p")], as.numeric)
```

```{r}
# Transform annual absolute change values and 95% CIs into percentages
forest$coef <- forest$coef * 100
forest$cilower <- forest$cilower * 100
forest$ciupper <- forest$ciupper * 100
forest$coef_text <- paste0(sprintf("%.2f", round(forest$coef, 2)), "%")
forest$CI_text <- paste0("(", 
                         sprintf("%.2f", forest$cilower), "%, ",
                         sprintf("%.2f", forest$ciupper), "%)")

# Correct for p-values
forest$p_text <- ifelse(forest$p == 0, "<0.001", as.character(forest$p))

# Add "Reference" for reference levels
reference_terms <- c("Non-Hispanic White", "Private", "Academic/research program", "<10", "1st quartile (lowest)")
forest <- forest %>% mutate(
  coef_text = case_when(term %in% reference_terms ~ "Reference", 
                        TRUE ~ coef_text),
  CI_text = case_when(term %in% reference_terms ~ "Reference",
                      TRUE ~ CI_text),
  coef = case_when(term %in% reference_terms ~ 0, TRUE ~ coef),
  cilower = case_when(term %in% reference_terms ~ 0, TRUE ~ cilower),
  ciupper = case_when(term %in% reference_terms ~ 0, TRUE ~ ciupper))

# Define model names
main_vars <- c("Model 1: Race/ethnicity", 
               "Model 2: Insurance", 
               "Model 3: Facility Type",
               "Model 4: Great Circle Distance (miles)",
               "Model 5: Zip-code-level Education", 
               "Model 6: Zip-code-level Income")

# Create indented labels and blank values for model name rows
forest <- forest %>%
  mutate(
    term_display = ifelse(term %in% main_vars, term, paste0("   ", term)),
    coef_text = ifelse(term %in% main_vars, "", coef_text),
    CI_text = ifelse(term %in% main_vars, "", CI_text),
    coef = ifelse(term %in% main_vars, NA, coef),
    cilower = ifelse(term %in% main_vars, NA, cilower),
    ciupper = ifelse(term %in% main_vars, NA, ciupper))

# Format all p-values to 3 decimals
forest$p_text <- ifelse(
  forest$p_text == "<0.001",
  forest$p_text,  # keep "< 0.001" as is
  sprintf("%.3f", as.numeric(forest$p_text))  )

# Define headers for forest plot
headers <- c("Models", "Annual Absolute Change", "95% CI", "P-value")

# Build label matrix
label_matrix <- rbind(headers, as.matrix(forest[, c("term_display", "coef_text", "CI_text", "p_text")]))

# Build vectors for plotting (add NA row for header)
mean_vals <- c(NA, forest$coef)
lower_vals <- c(NA, forest$cilower)
upper_vals <- c(NA, forest$ciupper)
```

## Generate forest plot
```{r}
tiff("forest_plot.tiff", width = 13, height = 20, units = "in", res = 300)
forestplot(labeltext = label_matrix,
           mean = mean_vals,
           lower = lower_vals,
           upper = upper_vals,
           zero = 0,
           boxsize = 0.25,
           lineheight = unit(12, 'mm'),
           graphwidth = unit(70, 'mm'),
           colgap = unit(4, 'mm'),
           lwd.zero = 2,
           lwd.ci = 2.5,
           col = fpColors(box = "#2066a8", lines = "black", zero = "black"),
           xlab = "Annual Absolute Change (%)",
           txt_gp = fpTxtGp(label = gpar(cex = 1.2),
                            ticks = gpar(cex = 1.0),
                            xlab = gpar(cex = 1.4),
                            title = gpar(cex = 1.1)),
           lwd.xaxis = 2,
           lty.ci = "solid",
           ci.vertices = TRUE,
           ci.vertices.height = 0.1,
           graph.pos = 2,
           xticks = seq(-1, 0.6, by = 0.2),
           xticks.digits = 2,
           hrzl_lines = list(
             "2" = gpar(lwd = 2, col = "black"),
             "8" = gpar(lwd = 2, col = "black"),
             "13" = gpar(lwd = 2, col = "black"),
             "17" = gpar(lwd = 2, col = "black"),
             "22" = gpar(lwd = 2, col = "black"),
             "27" = gpar(lwd = 2, col = "black")))

dev.off()
```
